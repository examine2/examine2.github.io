<!DOCTYPE html>
<html lang="en">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.4.2">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/32X32.ico?v=7.4.2">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/16X16.ico?v=7.4.2">
  <link rel="mask-icon" href="/images/logo.svg?v=7.4.2" color="#222">

<link rel="stylesheet" href="/css/main.css?v=7.4.2">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Noto Serif SC:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '7.4.2',
    exturl: false,
    sidebar: {"position":"right","display":"post","offset":12,"onmobile":false},
    copycode: {"enable":true,"show_result":true,"style":null},
    back2top: {"enable":true,"sidebar":true,"scrollpercent":true},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: '',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: 'Copy',
      copy_success: 'Copied',
      copy_failure: 'Copy failed'
    },
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="&amp;emsp;">
<meta name="keywords" content="CTF,MISC">
<meta property="og:type" content="article">
<meta property="og:title" content="png图片格式">
<meta property="og:url" content="http:&#x2F;&#x2F;yoursite.com&#x2F;2020&#x2F;02&#x2F;12&#x2F;png%E5%9B%BE%E7%89%87%E6%A0%BC%E5%BC%8F&#x2F;index.html">
<meta property="og:site_name" content="examine2&#39;s Blog">
<meta property="og:description" content="&amp;emsp;">
<meta property="og:locale" content="en">
<meta property="og:image" content="http:&#x2F;&#x2F;yoursite.com&#x2F;images&#x2F;image_format&#x2F;crc_error.png">
<meta property="og:image" content="http:&#x2F;&#x2F;yoursite.com&#x2F;images&#x2F;image_format&#x2F;2_png_data.png">
<meta property="og:image" content="http:&#x2F;&#x2F;yoursite.com&#x2F;images&#x2F;image_format&#x2F;calc_crc32.png">
<meta property="og:image" content="http:&#x2F;&#x2F;yoursite.com&#x2F;images&#x2F;image_format&#x2F;2_png_change.png">
<meta property="og:image" content="http:&#x2F;&#x2F;yoursite.com&#x2F;images&#x2F;image_format&#x2F;png_check.png">
<meta property="og:image" content="http:&#x2F;&#x2F;yoursite.com&#x2F;images&#x2F;image_format&#x2F;pngcheck_sctf.png">
<meta property="og:image" content="http:&#x2F;&#x2F;yoursite.com&#x2F;images&#x2F;image_format&#x2F;pngcheck_sctf2.png">
<meta property="og:image" content="http:&#x2F;&#x2F;yoursite.com&#x2F;images&#x2F;image_format&#x2F;png_unfilled.png">
<meta property="og:image" content="http:&#x2F;&#x2F;yoursite.com&#x2F;images&#x2F;image_format&#x2F;png_hex.png">
<meta property="og:image" content="http:&#x2F;&#x2F;yoursite.com&#x2F;images&#x2F;image_format&#x2F;zlib_result.png">
<meta property="og:updated_time" content="2020-02-13T06:05:01.744Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http:&#x2F;&#x2F;yoursite.com&#x2F;images&#x2F;image_format&#x2F;crc_error.png">

<link rel="canonical" href="http://yoursite.com/2020/02/12/png%E5%9B%BE%E7%89%87%E6%A0%BC%E5%BC%8F/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true,
    isPage: false,
    isArchive: false
  };
</script>

  <title>png图片格式 | examine2's Blog</title>
  








  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript><!-- hexo-inject:begin --><!-- hexo-inject:end -->

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container use-motion">
    <div class="headband"></div>
		<a href="https://github.com/examine2" target="_blank" rel="noopener" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">examine2's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-首页">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-关于">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
        <li class="menu-item menu-item-标签">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-分类">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-归档">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
  </ul>

</nav>
</div>
    </header>

    


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/12/png%E5%9B%BE%E7%89%87%E6%A0%BC%E5%BC%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/none.ico">
      <meta itemprop="name" content="examine">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="examine2's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          png图片格式
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-02-12 22:13:48" itemprop="dateCreated datePublished" datetime="2020-02-12T22:13:48+08:00">2020-02-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-02-13 14:05:01" itemprop="dateModified" datetime="2020-02-13T14:05:01+08:00">2020-02-13</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CTF/" itemprop="url" rel="index">
                    <span itemprop="name">CTF</span>
                  </a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2020/02/12/png%E5%9B%BE%E7%89%87%E6%A0%BC%E5%BC%8F/#comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2020/02/12/png%E5%9B%BE%E7%89%87%E6%A0%BC%E5%BC%8F/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>10k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>17 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>&emsp;</p>
<a id="more"></a>



<h2 id="PNG图片格式"><a href="#PNG图片格式" class="headerlink" title="PNG图片格式"></a>PNG图片格式</h2><ul>
<li><strong>图种</strong>：<code>jpg</code> 图片有文件尾标识 <code>FF D9</code>，而图片查看器只读取 <code>FF D9</code> 之前的数据显示为图片，因此 <code>FF D9</code> 之后的空间能够存放隐藏数据；<code>png</code> 的末尾 <code>00 00 00 00 49 45 4e 44 ae 42 60 82</code> 充当文件尾标识，情况类似</li>
<li><strong>LSB隐写</strong>：将数据藏匿在最低有效位，因此只适合 <strong>无损压缩 <code>png</code></strong> 或 <strong>无压缩 <code>bmp</code></strong> 图片格式</li>
</ul>
<p>很显然，想要更深入的了解<strong>图片隐写</strong>，就必须对常见的图片格式有所了解</p>
<p>本篇介绍 <strong><code>png</code></strong> 图片格式</p>
<hr>
<h3 id="数据块-Chunk"><a href="#数据块-Chunk" class="headerlink" title="数据块(Chunk)"></a>数据块(Chunk)</h3><p><strong>文件头标识</strong> ——（8 bytes）<code>89 50 4E 47 0D 0A 1A 0A</code>，ASCII码为 <code>.PNG....</code></p>
<p><code>png</code> 文件由<strong>数据块（Chunk）</strong>组成，每个<strong>Chunk</strong>都必须包含：</p>
<ul>
<li><p>长度<strong>（Length）</strong>：4 bytes</p>
</li>
<li><p>数据块类型<strong>（Chunk Type）</strong>：4 bytes</p>
</li>
<li><p>数据块数据<strong>（Chunk Data）</strong>：<strong>Length</strong> bytes</p>
</li>
<li><p><strong>CRC</strong>校验码：4 bytes，由Chunk Type和Chunk Data计算而来</p>
<blockquote>
<p><strong>CRC</strong>是<strong>循环冗余校验(Cyclic Redundancy Check)</strong>的缩写，它能根据数据产生简短的<strong>固定位数校验码</strong>，能够用来校验数据传输前后的完整性</p>
<p>数据中哪怕是 <code>1 bit</code> 的改动，也会导致完全不一样的CRC校验码</p>
<p>数据传输过程中难免会出现差错，那么可以在传输前对数据进行CRC计算、传输后再计算，如果两个CRC结果不一致，就应该要求重新传输数据</p>
</blockquote>
</li>
</ul>
<p>我们来重点分析 <code>png</code> 的第一个Chunk：<strong>IHDR Chunk</strong></p>
<hr>
<h3 id="IHDR-Chunk"><a href="#IHDR-Chunk" class="headerlink" title="IHDR Chunk"></a><strong>IHDR Chunk</strong></h3><h4 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h4><p>IHDR Chunk又称为<strong>图片文件头数据块（image header chunk）</strong>，是 <code>png</code> 图片的第一个chunk，一张 <code>png</code> 图片<strong>有且仅有</strong>一个IHDR Chunk</p>
<p>IHDR Chunk包含了 <code>png</code> 图片的基本信息：</p>
<ul>
<li>宽、高</li>
<li>颜色深度</li>
<li>颜色类型</li>
<li>压缩方法</li>
<li>......</li>
</ul>
<p>我们假设用十六进制查看器打开一张 <code>png</code> 图片，数据如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">0000000: 8950 4e47 0d0a 1a0a 0000 000d 4948 4452 .PNG........IHDR</span><br><span class="line">0000010: 0000 0010 0000 0010 0800 0000 003a 98a0 .............:..</span><br><span class="line">0000020: bd00 0000 0774 494d 4507 da0a 0a07 150b .....tIME....... </span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>前<strong>8</strong>个固定字节属于文件头标识：<code>89 50 4e 47 0d 0a 1a 0a</code></p>
<p>紧接着的<strong>4</strong>个字节是 <code>00 00 00 0d</code>，它属于chunk的Length域，也就是说这个chunk的Chunk Data域的长度应该为 <code>0x0d = 13</code> 个字节</p>
<blockquote>
<p>从Length开始已经进入了 <code>png</code> 文件的第一个chunk——IHDR Chunk了</p>
</blockquote>
<p>再往后取<strong>4</strong>个字节，<code>49 48 44 52</code>，对应chunk的Chunk Type，其对应的ASCII字符为 <code>IHDR</code></p>
<p>接下来应该是Chunk Data域了，它的长度由Length确定，所以有 <strong><code>0x0d = 13</code></strong> 个字节</p>
<p>就如之前所说的，IHDR Chunk包含 <code>png</code> 文件的许多信息，这些信息就包含在IHDR Chunk的Chunk Data里面。这 <code>13</code> 个字节分别代表：</p>
<ul>
<li><p>宽度<strong>（Width）</strong>：<strong>4</strong> bytes</p>
</li>
<li><p>高度<strong>（Height）</strong>：<strong>4</strong> bytes</p>
</li>
<li><p>颜色深度<strong>（Bit Depth）</strong>：<strong>1</strong> byte</p>
<blockquote>
<p><strong>注意</strong></p>
<p>颜色深度（Bit Depth）应该与另一个概念<strong>位深度</strong>一起理解</p>
<ul>
<li><strong>位深度</strong>表示RGBA通道中，每个通道的位数</li>
<li><strong>颜色深度</strong>表示RGBA四个通道总共的位数，有 <code>4 * 位深度 = 颜色深度</code></li>
</ul>
<p>不要被英文翻译弄晕了</p>
<p>不同的位图软件会以不同的角度去解释图像的<strong>位深度</strong>，有可能同一张图片，在十六进制查看器中显示颜色深度为8 bytes；而查看图片属性却显示位深度为32 bytes</p>
</blockquote>
</li>
<li><p>颜色类型<strong>（Color Type）</strong>：<strong>1</strong> byte</p>
</li>
<li><p>压缩方法<strong>（Compression Method）</strong>：<strong>1</strong> byte</p>
</li>
<li><p>过滤方法<strong>（Filter Method）</strong>：<strong>1</strong> byte</p>
</li>
<li><p>扫描方法<strong>（Interlace Method）</strong>：<strong>1</strong> byte</p>
</li>
</ul>
<p>跳过Chunk Data的13个字节，IHDR Chunk的最后<strong>4</strong>个字节 <code>3a 98 a0 bd</code> 是由Chunk Type和Chunk Data计算得到的CRC校验码</p>
<hr>
<h4 id="CRC计算方法（可跳过）"><a href="#CRC计算方法（可跳过）" class="headerlink" title="CRC计算方法（可跳过）"></a>CRC计算方法（可跳过）</h4><p>任意一个<strong>二进制数</strong>都可以与一个<strong>系数仅为 <code>0</code> 或 <code>1</code> 的多项式</strong>一一对应</p>
<blockquote>
<p>例如，<code>1010111</code> 对应 $x^6+x^4+x^2+x+1$，而$x^5+x^3+x^2+x+1$对应 <code>101111</code></p>
</blockquote>
<p>在计算CRC码之前，都要选定一个<strong>参数模型</strong>，<strong>参数模型</strong>就是上面的<strong>多项式</strong></p>
<p>我们可以将$x^6+x^4+x^2+x+1$称之为<strong>CRC-6</strong>；将$x^5+x^3+x^2+x+1$称之为<strong>CRC-5</strong>；但是光<strong>CRC-6</strong>就有许多种——只要最高项指数为6、系数为1的，都是</p>
<p>科学家对CRC的研究延伸出<strong>生成多项式</strong>，专门用于研究如何选定一个多项式为<strong>CRC-6</strong>，使得CRC-6的性能提升（CRC类似哈希算法，理应避免哈希碰撞）</p>
<p>就目前而言，广泛使用的<strong>CRC-5</strong>是$x^5+x^2+1$、而不是$x^5+x^3+x^2+x+1$；广泛使用的<strong>CRC-6</strong>是$x^6+x+1$，而不是$x^6+x^4+x^2+x+1$</p>
<blockquote>
<p>选定CRC的多项式是有数学依据的，但这篇文章不讨论这个</p>
</blockquote>
<blockquote>
<p>我们用自定义的<strong>CRC-3</strong>来快速演示一下CRC的计算过程：</p>
<p>假设选定多项式为：$x^3+x+1$</p>
<p>假设原始数据为 <code>1010</code>，求 <code>1010</code> 经过我们自定义的CRC-3编码后，得到的CRC码：</p>
<ol>
<li><p>多项式$x^3+x+1$对应的二进制数是 <code>1011</code></p>
</li>
<li><p>我们把最高项指数称为<strong>R</strong>，在这里，$R = 3$</p>
<p>（<strong>R</strong>是CRC的命名依据，并且也是生成CRC码的<strong>二进制</strong>位数）</p>
<p>把原始数据 <code>1010</code> 左移<strong>R</strong>位，得到移位数据 <code>1010000</code></p>
</li>
<li><p>移位数据与<strong>多项式对应二进制数</strong>进行<strong>模2除法</strong></p>
<blockquote>
<p><strong>模2除法</strong></p>
<p>普通除法过程中的<strong>加减法</strong>全部改成<strong>异或运算</strong></p>
</blockquote>
<p>得到 <code>1011011</code></p>
</li>
<li><p>取<strong>异或运算</strong>结果的<strong>后R位</strong>，也就是 <code>011</code>，这个就是生成的CRC码</p>
</li>
</ol>
<p>具体可以参见文章<a href="https://blog.csdn.net/Kj1501120706/article/details/73330526" target="_blank" rel="noopener">https://blog.csdn.net/Kj1501120706/article/details/73330526</a></p>
</blockquote>
<hr>
<p>回到我们 <code>png</code> 的IHDR Chunk的CRC码 <code>3a 98 a0 bd</code>，它是由Chunk Type和Chunk Data计算得到的CRC校验码</p>
<p>Chunk Type和Chunk Data的数据为 <code>4948 4452 0000 0010 0000 0010 0800 0000 00</code>，这就是CRC计算中的原始数据</p>
<p>对于 <code>png</code>，默认使用<strong>CRC-32</strong>：<br>$$<br>x^{32}+x^{26}+x^{23}+x^{22}+x^{16}+x^{12}+x^{11}+x^{10}+x^8+x^7+x^5+x^4+x^2+x+1<br>$$</p>
<h4 id="Python-2计算CRC-32"><a href="#Python-2计算CRC-32" class="headerlink" title="Python 2计算CRC-32"></a>Python 2计算CRC-32</h4><p>使用Python 2是借助<strong>zlib库</strong>可以快速计算CRC-32的，以上面的原始数据为例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> zlib</span><br><span class="line">s = <span class="string">"\x49\x48\x44\x52\x00\x00\x00\x10\x00\x00\x00\x10\x08\x00\x00\x00\x00"</span></span><br><span class="line">c = zlib.crc32(s) &amp; <span class="number">0xffffffff</span></span><br><span class="line"><span class="keyword">print</span> hex(c)</span><br><span class="line">	<span class="comment"># 0x3a98a0bd</span></span><br></pre></td></tr></table></figure>

<p>可以看到，得到的结果的确是我们想要的 <code>3a 98 a0 bd</code></p>
<blockquote>
<p>原始数据必须转换成 <code>\x</code> 形式，它表示单字节编码；而 <code>0x</code> 是不行的</p>
<p><code>\x</code> 表示一个不能直接显示的单字节字符的编码；<code>0x</code> 便是一个标准十六进制的字符串</p>
</blockquote>
<blockquote>
<p><strong>补充</strong></p>
<p>Python 2中 <code>crc32()</code> 的值域为 $[-2^{31},2^{31}-1]$之间的整数，而更为广泛使用的<strong>CRC码</strong>（如Python 3、C语言）的取值范围为 $[0,2^{32}-1]$</p>
<p>为了修正Python 2中的CRC码，必须与 <code>0xffffffff</code> 进行<strong>与</strong>运算</p>
</blockquote>
<h4 id="Python-3计算CRC-32"><a href="#Python-3计算CRC-32" class="headerlink" title="Python 3计算CRC-32"></a>Python 3计算CRC-32</h4><p>Python 3同样有<strong>zlib库</strong>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> zlib</span><br><span class="line">s = <span class="string">b"\x49\x48\x44\x52\x00\x00\x00\x10\x00\x00\x00\x10\x08\x00\x00\x00\x00"</span></span><br><span class="line">c = zlib.crc32(s)</span><br><span class="line">print(hex(c))</span><br><span class="line">	<span class="comment"># 0x3a98a0bd</span></span><br></pre></td></tr></table></figure>

<p>注意Python 3的 <code>zlib.crc32()</code> 的参数必须是 <strong><code>bytes</code></strong>类型，而Python 3强制区分<strong>bytes</strong>和<strong>string</strong>的使用，为此在字符串 <code>s</code> 前面多加一个 <code>b</code></p>
<hr>
<p>在CTF中，有一类题目就是人为减小了IHDR Chunk中Chunk Data的<strong>Width</strong>或<strong>Height</strong>的值，这就导致图片查看器在解析 <code>png</code> 图片数据的时候，按照修改后的<strong>Width</strong>或<strong>Height</strong>会缺少图片部分区域的显示，这部分区域往往就隐藏着flag</p>
<p>为此，我们需要在十六进制编辑器中将<strong>Width</strong>或<strong>Height</strong>修改回来，而正确的<strong>Width</strong>或<strong>Height</strong>就隐藏在<strong>CRC码</strong>中</p>
<blockquote>
<p><strong>注意</strong></p>
<p>胡乱修改IHDR Chunk中的<strong>Width</strong>或<strong>Height</strong>，在<font color='red'>某些操作系统</font>中会导致<strong>CRC校验报错</strong>，从而无法打开 <code>png</code> 图片</p>
<p>比如<strong>Linux</strong>下的图片查看器就不会忽略<strong>错误的CRC校验码</strong>，因此用Linux打开修改过<strong>Width</strong>或<strong>Height</strong>的 <code>png</code> 图片，会出现打不开的情况</p>
<p>下图为Kali中打开CRC校验报错的 <code>png</code> 图片：</p>
<img src="/images/image_format/crc_error.png" style="zoom:67%;" />

<p>但是<strong>Windows</strong>是会忽略的，它会按照修改后的<strong>Width</strong>和<strong>Heigth</strong>来显示图片</p>
</blockquote>
<p>BugKu的杂项题目<a href="https://ctf.bugku.com/challenges" target="_blank" rel="noopener">隐写</a>就是这一类题目&emsp;&emsp;&emsp;<a href="https://ctf.bugku.com/files/f8da9b5979e89e91d083c7accdea4427/2.rar" target="_blank" rel="noopener">点击下载图片</a></p>
<blockquote>
<p>下载得到 <code>2.png</code>，用十六进制编辑器打开，查看IHDR Chunk的数据：</p>
<img src="/images/image_format/2_png_data.png" style="zoom:80%;" />

<p><code>png</code> 文件头标识 <code>89 50 4E 47 0D 0A 1A 0A</code> 没有问题</p>
<p>图片宽度为 <code>00 00 01 f4</code>，即 <code>500</code> 像素；高度为 <code>00 00 01 a4</code>，即 <code>420</code> 像素；CRC码为 <code>cb d6 df 8a</code></p>
<p>我们用Chunk Type和Chunk Data的数值来计算一下IHDR Chunk的CRC码：(Python 3)</p>
<img src="/images/image_format/calc_crc32.png" style="zoom: 67%;" />

<p>发现计算出来的CRC校验码与文件数据中的CRC校验码不同，猜测为更改了图片的宽度或高度</p>
<p>由于图片的宽度和高度的取值都在一个比较小的范围内，因此可以根据CRC码，爆破出正确的宽度或高度</p>
</blockquote>
<h4 id="png-CRC爆破"><a href="#png-CRC爆破" class="headerlink" title="png CRC爆破"></a><code>png</code> CRC爆破</h4><p>CRC码可以利用Python的 <code>zlib.crc32()</code> 函数求得，反过来，也可以用该函数进行爆破</p>
<p>由于图片宽度为 <code>500</code>像素、高度为 <code>420</code> 像素，所以假设高度被改小了，那么就基于<strong>CRC码</strong>和<strong>IHDR Chunk中其它数据</strong>，爆破出正确的高度值</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> zlib</span><br><span class="line"></span><br><span class="line"><span class="comment"># 十六进制字符串转bytes：两两分割字符串，对子串使用struct.pack()转换成bytes类型，拼接在一起</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hexStr2bytes</span><span class="params">(s)</span>:</span></span><br><span class="line">    b = <span class="string">b""</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,len(s),<span class="number">2</span>):</span><br><span class="line">        temp = s[i:i+<span class="number">2</span>]</span><br><span class="line">        b += struct.pack(<span class="string">"B"</span>, int(temp, <span class="number">16</span>))</span><br><span class="line">    <span class="keyword">return</span> b</span><br><span class="line"></span><br><span class="line"><span class="comment"># str1和str2分别是待爆破的Height前面的数据、后面的数据，呈现为16进制字符串</span></span><br><span class="line">str1 = <span class="string">"49484452000001f4"</span></span><br><span class="line">str2 = <span class="string">"0806000000"</span></span><br><span class="line">bytes1 = hexStr2bytes(str1)</span><br><span class="line">bytes2 = hexStr2bytes(str2)</span><br><span class="line"></span><br><span class="line">crc32 = <span class="string">"0xcbd6df8a"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 遍历高度h从0到1000</span></span><br><span class="line"><span class="keyword">for</span> h <span class="keyword">in</span> range(<span class="number">1000</span>):</span><br><span class="line">    str = hex(h)[<span class="number">2</span>:].rjust(<span class="number">8</span>, <span class="string">'0'</span>) <span class="comment"># 将十进制int转化为8位十六进制数，rjust()用于补齐</span></span><br><span class="line">    bytes_temp = hexStr2bytes(str)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> hex(zlib.crc32(bytes1+bytes_temp+bytes2)) == crc32:</span><br><span class="line">        print(h)</span><br><span class="line">        </span><br><span class="line"><span class="comment"># 脚本是自己写的，跟网上常见的binascii有所不同</span></span><br></pre></td></tr></table></figure>

<p>上面的<strong>Python 3</strong>代码主要应用了<strong><code>zlib.crc32()</code></strong>和<strong><code>struct.pack()</code></strong>函数来爆破<strong>Height</strong></p>
<p>执行代码的运行结果为： <code>500</code>，所以对应CRC码的正确高度值应该为 <code>500</code> 像素</p>
<p><code>500</code> 对应十六进制 <code>1f4</code>，那么在十六进制编辑器中将 <code>png</code> 的高度修改回 <code>1f4</code>：</p>
<img src="/images/image_format/2_png_change.png" style="zoom:80%;" />

<p>再次打开 <code>2.png</code>，发现将高度修正后，图片查看器将显示出被遮掩的部分，flag出现</p>
<blockquote>
<p>补充一篇网上的 <code>png</code> CRC爆破代码，修改过适用于本题：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line">misc = open(<span class="string">"2.png"</span>,<span class="string">"rb"</span>).read()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> h <span class="keyword">in</span> range(<span class="number">1024</span>):</span><br><span class="line"> data = misc[<span class="number">12</span>:<span class="number">20</span>] + struct.pack(<span class="string">'&gt;i'</span>,h)+ misc[<span class="number">24</span>:<span class="number">29</span>]</span><br><span class="line"> crc32 = binascii.crc32(data) &amp; <span class="number">0xffffffff</span></span><br><span class="line"> <span class="keyword">if</span> crc32 == <span class="number">0xcbd6df8a</span>:</span><br><span class="line">     <span class="keyword">print</span> h</span><br></pre></td></tr></table></figure>

<p><strong>对比</strong></p>
<p>我原先的代码之所以写得这么长，主要有两个原因：</p>
<ul>
<li><p>没熟悉 <code>struct.pack()</code> 的使用方法</p>
<p><strong>struct库</strong>只要用于处理二进制数据，<code>pack()</code> 的API为 <code>pack(fmt, v1, v2)</code></p>
<p>第一个参数 <strong><code>fmt</code></strong> 表示 <code>pack()</code> 对数据处理的格式，<code>B</code> 是<strong>unsigned char</strong>的缩写，占<strong>1</strong> bytes；而 <code>i</code> 是<strong>integer</strong>的缩写，占<strong>4</strong> bytes</p>
<p>我傻傻地将高度 <code>h</code> 转换成8位十六进制数，两两拆分后，把每个单独的2为十六进制数再转换成<strong>int</strong>，最后使用 <code>B</code> 参数指定 <code>pack()</code> 生成<strong>1</strong>个bytes，再把<strong>4</strong>个的<strong>1</strong> bytes拼接起来</p>
<p>而使用 <code>i</code> 参数就不用这么麻烦，该参数直接指定生成<strong>4</strong> bytes</p>
<blockquote>
<p>留意到 <code>pack()</code> 接收的都是十进制数</p>
</blockquote>
<p>此外，<code>pack()</code> 提供 <code>&gt;</code> <code>&lt;</code> 来改变生成字节的顺序，默认为 <code>&lt;</code>，因此需要指定为 <code>&gt;</code></p>
<blockquote>
<p>详细部分可以参考文章：<a href="https://www.cnblogs.com/gala/archive/2011/09/22/2184801.html" target="_blank" rel="noopener">https://www.cnblogs.com/gala/archive/2011/09/22/2184801.html</a></p>
</blockquote>
</li>
<li><p>Python 2不像Python 3一样，对<strong>bytes</strong>和<strong>string</strong>有严格区分</p>
<p>留意到上面代码中，<code>struct.pack()</code> 返回的<strong>bytes</strong>与 <code>misc</code> 的切片<strong>string</strong>相加，这在Python 3中只会给你一个报错信息：<code>TypeError: can only concatenate str (not &quot;bytes&quot;) to str</code>，而这在Python 2中是允许的，节省了不少功夫</p>
</li>
<li><p><strong><code>0xffffffff</code></strong></p>
<p>首先得指出，<strong>binascii库</strong>和<strong>zlib库</strong>的 <code>crc32()</code> 函数都是<strong>一样</strong>的&emsp;&emsp;<font color='red'>←存疑</font></p>
<p>在Python 2中，<code>crc32()</code> 计算处理的<strong>CRC</strong>值域为$[-2^{31}, 2^{31}]$之间的<strong>有符号整数</strong>，为了与一般的CRC结果作对比，需要将其转换为<strong>无符号整数</strong>，所以与 <code>0xffffffff</code> 进行<strong>&amp;</strong>运算来进行转换</p>
<p>Python 3的计算结果是$[0, 2^{32}-1]$间的<strong>无符号整数</strong>，无需额外的转换</p>
<p>因此这个 <code>0xffffffff</code> 的出现是因为Python的版本问题</p>
</li>
</ul>
</blockquote>
<h4 id="直接修改"><a href="#直接修改" class="headerlink" title="直接修改"></a>直接修改</h4><p>Thanks to Windows对错误的CRC校验码的忽略，我们可以直接将高度修改为<strong>较大的值</strong>，可以很快解决掉这种类型的CTF题目</p>
<p>相比于<strong>CRC爆破</strong>，这种方法是最快的</p>
<hr>
<h3 id="All-Chunks"><a href="#All-Chunks" class="headerlink" title="All Chunks"></a>All Chunks</h3><p><code>png</code> 文件主要由<strong>4</strong>大块（Chunk）组成：</p>
<ul>
<li>文件头数据块<strong>IHDR</strong>（header chunk）</li>
<li>调色板数据块<strong>PLTE</strong>（palette chunk）</li>
<li>图像数据块<strong>IDAT</strong>（data chunk）</li>
<li>图像结束数据块<strong>IEND</strong>（trailer chunk）</li>
</ul>
<p>上面<strong>4</strong>个数据块是 <code>png</code> 最主要的数据块</p>
<blockquote>
<p>还有其它算不上重要的数据块，比如：</p>
<ul>
<li>在<strong>PLTE</strong>和<strong>IDAT</strong>之前的：cHRM 基色和白色点数据块、gAMA 图像Y数据块、sBIT 样本有效位数据块</li>
<li>介于<strong>PLTE</strong>和<strong>IDAT</strong>之间的：bKGD 背景颜色数据块、hIST 图像直方图数据块、tRNS 图像透明数据块</li>
<li>无位置限制的：tIME 图像最后修改时间数据块、tEXt 文本信息数据块 ...</li>
</ul>
</blockquote>
<p>每个数据块都是由<strong>Length</strong>、<strong>Chunk Type</strong>、<strong>Chunk Data</strong>、<strong>CRC码</strong>构成</p>
<hr>
<h3 id="IEND-Chunk"><a href="#IEND-Chunk" class="headerlink" title="IEND Chunk"></a>IEND Chunk</h3><p>每个正常的 <code>png</code> 图片文件的<strong>IEND Chunk</strong>都是<strong>固定</strong>的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">00 00 00 00 49 45 4e 44 ae 42 60 82</span><br></pre></td></tr></table></figure>

<p>按照chunk的结构进行分析：</p>
<ul>
<li><p><strong>Length</strong>占<strong>4</strong> bytes，因此 <code>00 00 00 00</code> 就是IEND Chunk的长度</p>
<p>又因为<strong>Chunk Data</strong>的大小就取决于<strong>Length</strong>，因此可以看到：<strong>IEND Chunk</strong>的<strong>Chunk Data</strong>是空的，没有分配哪怕<strong>1</strong> bytes的空间给它</p>
</li>
<li><p><strong>Chunk Type</strong>也占<strong>4</strong> bytes，而 <code>49 45 4e 44</code> 对应的ASCII字符恰好就是 <code>IEND</code></p>
</li>
<li><p>最后的<strong>4</strong> bytes属于<strong>CRC</strong>，我们可以计算一下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> zlib</span><br><span class="line">s = <span class="string">b"\x49\x45\x4e\x44"</span></span><br><span class="line">print(hex(zlib.crc32(s)))</span><br><span class="line">	<span class="comment"># 0xae426082</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>由于<strong>IEND Chunk</strong>的长度为0，导致<strong>Chunk Data</strong>为空；又由于<strong>Chunk Type</strong>是固定的 <code>IEND</code>，导致计算出来的<strong>CRC码</strong>也是固定的</p>
<p>综上，每个 <code>png</code> 文件的<strong>IEND Chunk</strong>都是 <code>00 00 00 00 49 45 4e 44 ae 42 60 82</code>，占<strong>12</strong>字节，它作为 <code>png</code> 文件的<strong>文件尾标识</strong></p>
<blockquote>
<p>我们知道，<strong>图种</strong>的原理就是利用<strong>文件尾标识</strong>之后的数据不被图片查看器解析成图片，因此 <code>png</code> 与 <code>jpg</code> 一样可作为<strong>图种</strong>的载体</p>
<blockquote>
<p><strong>习题</strong>：格式为flag{xxx}</p>
<p>链接：<a href="https://pan.baidu.com/s/1Ze6bct3jA8qJt-zh0sNBKg" target="_blank" rel="noopener">https://pan.baidu.com/s/1Ze6bct3jA8qJt-zh0sNBKg</a><br>提取码：8vsh </p>
</blockquote>
</blockquote>
<hr>
<h3 id="IDAT-Chunk"><a href="#IDAT-Chunk" class="headerlink" title="IDAT Chunk"></a>IDAT Chunk</h3><h4 id="介绍-1"><a href="#介绍-1" class="headerlink" title="介绍"></a>介绍</h4><p>作为 <code>png</code> 图片中存储实际数据的数据块<strong>Data Chunk</strong>，它在 <code>png</code> 中的存在并不像<strong>IHDR Chunk</strong>那样是唯一的。相反，它可以有很多个，但所有的<strong>IDAT Chunk</strong>必须<strong>连续存在</strong></p>
<p>总结一下，它有如下特点：</p>
<ul>
<li>一个 <code>png</code> 文件可能有多个<strong>连续</strong>的<strong>IDAT Chunk</strong>，而<strong>IHDR</strong>、<strong>PLTE</strong>、<strong>IEND</strong>都是唯一存在的</li>
<li><strong>IDAT Chunk</strong>的数据都是经过<strong>LZ77派生算法</strong>压缩过的，数据不可读；可以用<strong>zlib</strong>解压缩</li>
<li><strong>IDAT Chunk</strong>只有上一个块充满，才会开启一个新的块</li>
</ul>
<p>由于<strong>IDAT Chunk</strong>是多个存在的，我们就可以将隐写信息以<strong>IDAT Chunk</strong>的形式加入图片中，将信息隐藏起来</p>
<p>检索隐藏在<strong>IDAT Chunk</strong>中的信息比较麻烦，因此我们借用工具：<strong>pngcheck</strong></p>
<hr>
<h4 id="pngcheck简介"><a href="#pngcheck简介" class="headerlink" title="pngcheck简介"></a><strong>pngcheck</strong>简介</h4><p><strong>pngcheck</strong>能够检查文件的结构以验证完整性（通过检查内部的32位CRC校验码、并解压缩图像数据），以人类可读的方式转储图像中的块级信息</p>
<p>据<a href="http://www.libpng.org/pub/png/apps/pngcheck.html" target="_blank" rel="noopener">pngcheck官网</a>显示，<strong>pngcheck</strong>支持所有的 <code>png</code> 块、<code>jng</code> 块、<code>mng</code> 块</p>
<hr>
<h4 id="pngcheck安装"><a href="#pngcheck安装" class="headerlink" title="pngcheck安装"></a><strong>pngcheck</strong>安装</h4><p><strong>pngcheck</strong>貌似在kali上是自带的，在Linux系统上安装只需执行命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo apt install pngcheck</span></span><br></pre></td></tr></table></figure>

<p>安装成功后输入 <code>$ pngcheck</code>，可以看到使用方法：</p>
<img src="/images/image_format/png_check.png" style="zoom:67%;" />

<p><strong>pngcheck</strong>在Windows上也可以安装，方法自寻</p>
<hr>
<h4 id="pngcheck使用"><a href="#pngcheck使用" class="headerlink" title="pngcheck使用"></a><strong>pngcheck</strong>使用</h4><p>我们以<strong>sctf</strong>的一道题来演示这类题目的解题过程</p>
<blockquote>
<p>链接：<a href="https://pan.baidu.com/s/1D6ORthAZH5TVsoeyBNZyfA" target="_blank" rel="noopener">https://pan.baidu.com/s/1D6ORthAZH5TVsoeyBNZyfA</a><br>提取码：rrb8 </p>
</blockquote>
<p>建议自己按常规套路对图片进行一番信息检索</p>
<p>&emsp;</p>
<p><strong>解答</strong></p>
<p>使用<strong>pngcheck</strong>对 <code>sctf.png</code> 进行检索，注意添加 <code>-v</code> 参数，使其罗列详细数据：</p>
<img src="/images/image_format/pngcheck_sctf.png" style="zoom:67%;" />

<p><strong>pngcheck</strong>首先检查了<strong>IHDR Chunk</strong>，并将里面的文件信息显示了出来：宽1000像素、高562像素、位深度32，无扫描方法(interlace method)</p>
<p>随后<strong>pngcheck</strong>依次检查了sRGB Chunk、gAMA Chunk、pHYs Chunk，并对每个检索到的chunk都显示<strong>名称</strong>、<strong>偏移量offset</strong>、长度<strong>length</strong></p>
<blockquote>
<p>这里有两点关于<strong>pngcheck</strong>显示的数据的要点</p>
<ol>
<li><p><strong>pngcheck</strong>检索每个块的<strong>length</strong>只是这个块的<strong>Chunk Data</strong>占用的字节数</p>
<p>我们可以根据上图计算一下：</p>
<blockquote>
<p>比如<strong>IHDR</strong>和<strong>sRGB</strong>，两者的偏移量相减：<code>0x00025 - 0x0000c = 0x00019 = 25</code>，也就是说<strong>IHDR</strong>总共占用25个字节，而<strong>pngcheck</strong>显示 <code>length 13</code>，很明显它不将<strong>IHDR</strong>中，<strong>Length</strong>的<strong>4</strong>字节、<strong>Chunk Type</strong>的<strong>4</strong>字节、<strong>CRC</strong>的<strong>4</strong>字节——总共<strong>12</strong>字节统计在内，满足 <code>13 + 12 = 25</code></p>
</blockquote>
</li>
<li><p><strong>pngcheck</strong>的<strong>offset</strong>指到一个chunk的<strong>Chunk Type</strong>，而不是<strong>Length</strong></p>
<blockquote>
<p>我们直接看<strong>IHDR Chunk</strong>，抛却 <code>png</code> 最开始的<strong>8</strong>字节的文件头标识，<strong>IHDR Chunk</strong>的开始应该是 <code>0x00008</code>（从 <code>0x00000</code> 到 <code>0x00007</code> 是文件头标识），而上图却显示为 <code>0x0000c</code>，两者相差的<strong>4</strong>个字节就是<strong>IHDR Chunk</strong>的<strong>Length</strong>了</p>
</blockquote>
</li>
</ol>
</blockquote>
<p>然后到了连续的多个<strong>IDAT Chunk</strong>以及最后的<strong>IEND Chunk</strong>：</p>
<img src="/images/image_format/pngcheck_sctf2.png" style="zoom:67%;" />

<p>最后的<strong>IEND Chunk</strong>的<strong>Chunk Data</strong>是空的，所以显示的 <code>length</code> 为0</p>
<p>但是在最后一个<strong>IDAT Chunk</strong>处出现了异常——我们知道，<strong>IDAT Chunk</strong>只有上一个块充满，才会开启一个新的块。按照前面的<strong>IDAT Chunk</strong>可知，正常的<strong>IDAT Chunk</strong> <code>length</code> 为<strong>65524</strong>时才满</p>
<p>我们发现倒数第二个<strong>IDAT Chunk</strong>的 <code>length</code> 只有45027，在它未满的情况下后面出现了 <code>length</code> 为138的新<strong>IDAT Chunk</strong>，我们可以断定，这个 <code>length</code> 为138的<strong>IDAT Chunk</strong>是人为添加进去的</p>
<blockquote>
<p><strong>关于IDAT Chunk的&quot;满&quot;</strong></p>
<p><code>png</code> 图片中，<strong>满</strong>不一定是<strong>65524</strong> bytes，这取决于图片本身</p>
<p>例如，我们打开一张正常的非隐写 <code>png</code> 图片，可以看到：</p>
<img src="/images/image_format/png_unfilled.png" style="zoom:67%;" />

<p>这里的<strong>满</strong>是<strong>32768</strong> bytes，最后一个<strong>IDAT Chunk</strong> <code>length</code> 为22583，未满</p>
<p>如何判断<strong>IDAT Chunk</strong>是否已<strong>满</strong>，根据大部分<strong>IDAT Chunk</strong>的 <code>length</code> 就可以得知</p>
</blockquote>
<p>既然发现了异常数据，那么可以用十六进制编辑器打开 <code>png</code>，定位到偏移量 <code>0x15aff7</code>：</p>
<img src="/images/image_format/png_hex.png" style="zoom: 67%;" />

<p>图中紫蓝色的十六进制数据部分就是定位到的异常chunk的数据</p>
<p>区域的开始位置为<strong>pngcheck</strong>检索到的偏移量 <code>0x0015aff7</code> + <code>4</code> = <code>0x0015affb</code>（要跳过<strong>Chunk Type</strong>），结束位置为<strong>IEND Chunk</strong>的偏移量 <code>0x0015b08d</code> - <code>8</code> = `0x0015b085（跳过<strong>RCR</strong>以及<strong>IEND Chunk</strong>的<strong>Length</strong>）</p>
<p>之前有提到，<strong>IDAT Chunk</strong>中的数据都是经过<strong>LZ77派生算法</strong>压缩过的，不可直接读，但可以使用<strong>zlib</strong>解压缩。解压缩的Python 2代码为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> zlib</span><br><span class="line">IDAT = <span class="string">"789c5d...897667"</span>.decode(<span class="string">'hex'</span>)</span><br><span class="line">result = zlib.decompress(IDAT)</span><br></pre></td></tr></table></figure>

<p>上面代码首先用 <code>decode()</code> 将十六进制数解码为bytes（注意Python 2不区分<strong>bytes</strong>和<strong>string</strong>），然后直接调用 <code>zlib.decompress()</code> 解压缩</p>
<p>得到的 <code>result</code> 为：</p>
<img src="/images/image_format/zlib_result.png" style="zoom:67%;" />

<p>事实上到这里已经可以结束了，这道题结合的综合知识比较多，剩余部分超出了这篇文章的讲解范畴</p>
<p>以上就是<strong>pngcheck</strong>的介绍</p>
<hr>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p><code>png</code> 文件头标识(8 bytes) <code>89 50 4E 47 0D 0A 1A 0A</code>，ASCII码为 <code>.PNG....</code></p>
<p>依次为<strong>4</strong>个关键数据块：<strong>IHDR</strong>、<strong>PLTE</strong>、<strong>IDAT</strong>、<strong>IEND</strong>，每个数据块包含<strong>Length(4 bytes)</strong>、<strong>Chunk Type(4 bytes)</strong>、<strong>Chunk Data(Length bytes)</strong>、<strong>CRC(4 bytes)</strong></p>
<ul>
<li><p><strong>IHDR Chunk</strong>，Length = 13 bytes，Chunk Data中<strong>Width(4 bytes)</strong>、<strong>Height(4 bytes)</strong></p>
<p>通过计算CRC码查看有没有修改宽高，计算代码：(Python 2，<strong>cmd</strong>快速使用版)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">str = <span class="string">"直接复制过来的十六进制字符串，形如 '49 28 0d a7  ' ，可以保留两端的空格"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> zlib</span><br><span class="line">str = str.strip().split(<span class="string">" "</span>)</span><br><span class="line">temp = reduce(<span class="keyword">lambda</span> x,y: x+y, map(<span class="keyword">lambda</span> x: chr(int(x, <span class="number">16</span>)), str))</span><br><span class="line"><span class="keyword">print</span> hex(zlib.crc32(temp) &amp; <span class="number">0xffffffff</span>)</span><br></pre></td></tr></table></figure>

<p>CRC码不匹配，宽高被修改，Windows下直接修正为较大的值；Linux下爆破出正确的宽度或高度</p>
</li>
<li><p><strong>IDAT Chunk</strong>，执行命令 <code>$ pngcheck -v temp.png</code>，查看有无异常的IDAT Chunk</p>
<p>IDAT Chunk中异常数据的解压缩代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> zlib</span><br><span class="line">IDAT = <span class="string">"789c5d...897667"</span>.decode(<span class="string">'hex'</span>)</span><br><span class="line">result = zlib.decompress(IDAT)</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>IEND Chunk</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">00 00 00 00 49 45 4e 44 ae 42 60 82</span><br></pre></td></tr></table></figure>

<p>文件尾不是上面的数值，可能存在图种</p>
</li>
</ul>
<hr>
<h2 id="随笔"><a href="#随笔" class="headerlink" title="随笔"></a>随笔</h2><p>理清了 <code>png</code> 的文件结构，顺便还拾起了堆在角落的Python知识</p>
<p><strong>总结</strong>那里，计算CRC的代码中的那句：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">temp = reduce(<span class="keyword">lambda</span> x,y: x+y, map(<span class="keyword">lambda</span> x: chr(int(x, <span class="number">16</span>)), str))</span><br></pre></td></tr></table></figure>

<p>事实上是</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">temp = <span class="string">""</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> str:</span><br><span class="line">	temp += chr(int(i, <span class="number">16</span>))</span><br></pre></td></tr></table></figure>

<p>缩写成一行而已</p>
<p>之所以把三行简单的语句弄成这么复杂的一句，是因为这是<strong>cmd快速使用版</strong>，只要从十六进制编辑器中复制异常数据出来，作为字符串赋值给 <code>str</code>，然后把 <code>str</code> 下面的4行代码复制到cmd中，就可以出结果了</p>
<p>之前写成三行代码的时候，发现 <code>for</code> 语句下面的那个<strong>缩进</strong>复制过去的时候会被cmd自动删去，得手动添加上一个缩进，这不符合所谓的&quot;快速使用版&quot;，因此想办法将这个缩进干掉，借用lambda、map、reduce写成了一行代码</p>
<p>我还有一个 <code>.py</code> 文件是直接调用出结果的，但在cmd中切换目录和找到这篇文章复制代码，这两者之间孰快孰慢，不知道...</p>
<p>新工具：</p>
<ul>
<li>pngcheck</li>
</ul>
<p>新函数：</p>
<ul>
<li><code>zlib.crc32()</code> —— 计算CRC码</li>
<li><code>struct.pack()</code> —— 字符串转换成Unicode码</li>
<li><code>zlib.decompress()</code> —— 解压缩</li>
</ul>
<hr>
<p>end</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/CTF/" rel="tag"># CTF</a>
              <a href="/tags/MISC/" rel="tag"># MISC</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-next post-nav-item">
                <a href="/2020/02/12/LSB%E9%9A%90%E5%86%99/" rel="next" title="LSB隐写">
                  <i class="fa fa-chevron-left"></i> LSB隐写
                </a>
            </div>

            <span class="post-nav-divider"></span>

            <div class="post-nav-prev post-nav-item">
                <a href="/2020/04/25/%E4%BA%8C%E7%BB%B4%E7%A0%81/" rel="prev" title="二维码">
                  二维码 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          
    <div class="comments" id="comments"></div>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#PNG图片格式"><span class="nav-number">1.</span> <span class="nav-text">PNG图片格式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#数据块-Chunk"><span class="nav-number">1.1.</span> <span class="nav-text">数据块(Chunk)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#IHDR-Chunk"><span class="nav-number">1.2.</span> <span class="nav-text">IHDR Chunk</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#介绍"><span class="nav-number">1.2.1.</span> <span class="nav-text">介绍</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#CRC计算方法（可跳过）"><span class="nav-number">1.2.2.</span> <span class="nav-text">CRC计算方法（可跳过）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Python-2计算CRC-32"><span class="nav-number">1.2.3.</span> <span class="nav-text">Python 2计算CRC-32</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Python-3计算CRC-32"><span class="nav-number">1.2.4.</span> <span class="nav-text">Python 3计算CRC-32</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#png-CRC爆破"><span class="nav-number">1.2.5.</span> <span class="nav-text">png CRC爆破</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#直接修改"><span class="nav-number">1.2.6.</span> <span class="nav-text">直接修改</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#All-Chunks"><span class="nav-number">1.3.</span> <span class="nav-text">All Chunks</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#IEND-Chunk"><span class="nav-number">1.4.</span> <span class="nav-text">IEND Chunk</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#IDAT-Chunk"><span class="nav-number">1.5.</span> <span class="nav-text">IDAT Chunk</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#介绍-1"><span class="nav-number">1.5.1.</span> <span class="nav-text">介绍</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#pngcheck简介"><span class="nav-number">1.5.2.</span> <span class="nav-text">pngcheck简介</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#pngcheck安装"><span class="nav-number">1.5.3.</span> <span class="nav-text">pngcheck安装</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#pngcheck使用"><span class="nav-number">1.5.4.</span> <span class="nav-text">pngcheck使用</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-number">2.</span> <span class="nav-text">总结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#随笔"><span class="nav-number">3.</span> <span class="nav-text">随笔</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="site-author-image" itemprop="image" alt="examine"
    src="/images/none.ico">
  <p class="site-author-name" itemprop="name">examine</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">7</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/examine2" title="GitHub &amp;rarr; https:&#x2F;&#x2F;github.com&#x2F;examine2" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
  </div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">examine</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    <span title="Symbols count total">64k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">1:46</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> v4.0.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">Theme – <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> v7.4.2
  </div>

        












        
      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js?v=3.1.0"></script>
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
<script src="/js/utils.js?v=7.4.2"></script><script src="/js/motion.js?v=7.4.2"></script>
<script src="/js/schemes/pisces.js?v=7.4.2"></script>
<script src="/js/next-boot.js?v=7.4.2"></script>



  


















  

  
      
<script type="text/x-mathjax-config">

  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$', '$'], ['\\(', '\\)'] ],
      processEscapes: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    TeX: {
      equationNumbers: {
        autoNumber: 'AMS'
      }
    }
  });

  MathJax.Hub.Register.StartupHook('TeX Jax Ready', function() {
    MathJax.InputJax.TeX.prefilterHooks.Add(function(data) {
      if (data.display) {
        var next = data.script.nextSibling;
        while (next && next.nodeName.toLowerCase() === '#text') {
          next = next.nextSibling;
        }
        if (next && next.nodeName.toLowerCase() === 'br') {
          next.parentNode.removeChild(next);
        }
      }
    });
  });

  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for (i = 0; i < all.length; i += 1) {
      element = document.getElementById(all[i].inputID + '-Frame').parentNode;
      if (element.nodeName.toLowerCase() == 'li') {
        element = element.parentNode;
      }
      element.classList.add('has-jax');
    }
  });
</script>
<script>
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mathjax@2/MathJax.js?config=TeX-AMS-MML_HTMLorMML', () => {
    MathJax.Hub.Typeset();
  }, window.MathJax);
</script>

    

  

  


<script>
NexT.utils.getScript('https://cdn.jsdelivr.net/npm/valine@1.3.10/dist/Valine.min.js', () => {
  var GUEST = ['nick', 'mail', 'link'];
  var guest = 'nick,mail,link';
  guest = guest.split(',').filter(item => {
    return GUEST.includes(item);
  });
  new Valine({
    el: '#comments',
    verify: true,
    notify: false,
    appId: 'AcnzIAQVbbnuGkhPPb8cjbgW-gzGzoHsz',
    appKey: 'TLbccV8U8hEzCr7sXQrbouRU',
    placeholder: "Welcome to comment.",
    avatar: 'mm',
    meta: guest,
    pageSize: '10' || 10,
    visitor: false,
    lang: 'zh-cn' || 'zh-cn',
    path: location.pathname,
    recordIP: false,
    serverURLs: ''
  });
}, window.Valine);
</script><!-- hexo-inject:begin --><!-- hexo-inject:end -->

</body>
</html>
