<!DOCTYPE html>
<html lang="en">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.4.2">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/32X32.ico?v=7.4.2">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/16X16.ico?v=7.4.2">
  <link rel="mask-icon" href="/images/logo.svg?v=7.4.2" color="#222">

<link rel="stylesheet" href="/css/main.css?v=7.4.2">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Noto Serif SC:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '7.4.2',
    exturl: false,
    sidebar: {"position":"right","display":"post","offset":12,"onmobile":false},
    copycode: {"enable":true,"show_result":true,"style":null},
    back2top: {"enable":true,"sidebar":true,"scrollpercent":true},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: '',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: 'Copy',
      copy_success: 'Copied',
      copy_failure: 'Copy failed'
    },
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="&amp;emsp;">
<meta name="keywords" content="CTF,Misc,Archive">
<meta property="og:type" content="article">
<meta property="og:title" content="CTF中的zip（上）">
<meta property="og:url" content="http:&#x2F;&#x2F;yoursite.com&#x2F;2021&#x2F;01&#x2F;11&#x2F;CTF%E4%B8%AD%E7%9A%84zip%EF%BC%88%E4%B8%8A%EF%BC%89&#x2F;index.html">
<meta property="og:site_name" content="examine2&#39;s Blog">
<meta property="og:description" content="&amp;emsp;">
<meta property="og:locale" content="en">
<meta property="og:image" content="https:&#x2F;&#x2F;examine-typora-picbed.oss-cn-beijing.aliyuncs.com&#x2F;img&#x2F;header.png">
<meta property="og:image" content="https:&#x2F;&#x2F;examine-typora-picbed.oss-cn-beijing.aliyuncs.com&#x2F;img&#x2F;first_data_chunk.png">
<meta property="og:image" content="https:&#x2F;&#x2F;examine-typora-picbed.oss-cn-beijing.aliyuncs.com&#x2F;img&#x2F;first_data_chunk.png">
<meta property="og:image" content="https:&#x2F;&#x2F;examine-typora-picbed.oss-cn-beijing.aliyuncs.com&#x2F;img&#x2F;ms_dos_time.png">
<meta property="og:image" content="https:&#x2F;&#x2F;examine-typora-picbed.oss-cn-beijing.aliyuncs.com&#x2F;img&#x2F;ms_dos_time.png">
<meta property="og:image" content="https:&#x2F;&#x2F;examine-typora-picbed.oss-cn-beijing.aliyuncs.com&#x2F;img&#x2F;flag_six.png">
<meta property="og:image" content="https:&#x2F;&#x2F;examine-typora-picbed.oss-cn-beijing.aliyuncs.com&#x2F;img&#x2F;script_crc32.png">
<meta property="og:image" content="https:&#x2F;&#x2F;examine-typora-picbed.oss-cn-beijing.aliyuncs.com&#x2F;img&#x2F;crc32_same.png">
<meta property="og:image" content="https:&#x2F;&#x2F;examine-typora-picbed.oss-cn-beijing.aliyuncs.com&#x2F;img&#x2F;11212.png">
<meta property="og:image" content="https:&#x2F;&#x2F;examine-typora-picbed.oss-cn-beijing.aliyuncs.com&#x2F;img&#x2F;empty_data.png">
<meta property="og:image" content="https:&#x2F;&#x2F;examine-typora-picbed.oss-cn-beijing.aliyuncs.com&#x2F;img&#x2F;dir.png">
<meta property="og:image" content="https:&#x2F;&#x2F;examine-typora-picbed.oss-cn-beijing.aliyuncs.com&#x2F;img&#x2F;flag.png">
<meta property="og:image" content="https:&#x2F;&#x2F;examine-typora-picbed.oss-cn-beijing.aliyuncs.com&#x2F;img&#x2F;jiami_or_not.png">
<meta property="og:image" content="https:&#x2F;&#x2F;examine-typora-picbed.oss-cn-beijing.aliyuncs.com&#x2F;img&#x2F;jiami.png">
<meta property="og:image" content="https:&#x2F;&#x2F;examine-typora-picbed.oss-cn-beijing.aliyuncs.com&#x2F;img&#x2F;secret_dir.png">
<meta property="og:image" content="https:&#x2F;&#x2F;examine-typora-picbed.oss-cn-beijing.aliyuncs.com&#x2F;img&#x2F;change.png">
<meta property="og:image" content="https:&#x2F;&#x2F;examine-typora-picbed.oss-cn-beijing.aliyuncs.com&#x2F;img&#x2F;just_one_encrypt.png">
<meta property="og:image" content="https:&#x2F;&#x2F;examine-typora-picbed.oss-cn-beijing.aliyuncs.com&#x2F;img&#x2F;end_dir.png">
<meta property="og:updated_time" content="2021-03-05T06:55:42.802Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https:&#x2F;&#x2F;examine-typora-picbed.oss-cn-beijing.aliyuncs.com&#x2F;img&#x2F;header.png">

<link rel="canonical" href="http://yoursite.com/2021/01/11/CTF%E4%B8%AD%E7%9A%84zip%EF%BC%88%E4%B8%8A%EF%BC%89/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true,
    isPage: false,
    isArchive: false
  };
</script>

  <title>CTF中的zip（上） | examine2's Blog</title>
  








  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript><!-- hexo-inject:begin --><!-- hexo-inject:end -->

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container use-motion">
    <div class="headband"></div>
		<a href="https://github.com/examine2" target="_blank" rel="noopener" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">examine2's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-首页">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-关于">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
        <li class="menu-item menu-item-标签">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-分类">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-归档">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
  </ul>

</nav>
</div>
    </header>

    


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/01/11/CTF%E4%B8%AD%E7%9A%84zip%EF%BC%88%E4%B8%8A%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/none.ico">
      <meta itemprop="name" content="examine">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="examine2's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          CTF中的zip（上）
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-01-11 11:15:57" itemprop="dateCreated datePublished" datetime="2021-01-11T11:15:57+08:00">2021-01-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-03-05 14:55:42" itemprop="dateModified" datetime="2021-03-05T14:55:42+08:00">2021-03-05</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CTF/" itemprop="url" rel="index">
                    <span itemprop="name">CTF</span>
                  </a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2021/01/11/CTF%E4%B8%AD%E7%9A%84zip%EF%BC%88%E4%B8%8A%EF%BC%89/#comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2021/01/11/CTF%E4%B8%AD%E7%9A%84zip%EF%BC%88%E4%B8%8A%EF%BC%89/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>9k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>15 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>&emsp;</p>
<a id="more"></a>

<blockquote>
<p>原创文章，未经许可严禁转载</p>
<p>Author：ex@m1ne2</p>
</blockquote>
<h2 id="zip文件格式"><a href="#zip文件格式" class="headerlink" title="zip文件格式"></a>zip文件格式</h2><p><code>.zip</code> 文件格式由<strong>菲尔·卡茨(Phil Katz)</strong>发明，属于当下主流的压缩格式之一</p>
<blockquote>
<p><code>.zip</code> 的竞争者包括 <code>.rar</code> 格式和开放源码的 <code>.7z</code> 格式</p>
<p>从性能上比较，<code>.rar</code> 和 <code>.7z</code> 较 <code>.zip</code> 格式压缩率更高，而且 <code>.7z</code> 由于提供了免费的压缩工具而在更多领域得到应用</p>
</blockquote>
<p>对于一个 <code>.zip</code> 文件来说，它由<strong>3</strong>部分组成，而每部分都有对应的<strong>文件头标记</strong>：</p>
<ul>
<li>压缩源文件数据区（简称<strong>数据区</strong>），文件头为 <code>50 4B 03 04</code></li>
<li>压缩源文件目录区（简称<strong>目录区</strong>），文件头为 <code>50 4B 01 02</code></li>
<li>压缩源文件目录结束标志（简称<strong>目录结束标志</strong>），文件头为 <code>50 4B 05 06</code></li>
</ul>
<p>其中，所有文件头都有 <code>50 4B</code>，其对应的ASCII码为 <code>PK</code>，纪念 <code>.zip</code> 的发明人<strong>Phil Katz</strong>先生</p>
<hr>
<p>我们首先来自制几个 <code>.zip</code> 文件</p>
<p>创建<strong>文本文件</strong> <code>1.txt</code>、<code>2.txt</code>、<code>3.txt</code>，里面分别只有一句话：&quot;First Text&quot;、&quot;Second Text&quot;、&quot;Third Text&quot;（无回车符）</p>
<p>然后通过Bandizip或其它压缩软件，将3个 <code>.txt</code> 压缩成 <code>temp.zip</code>（无需密码）</p>
<p>我们用十六进制编辑器打开 <code>temp.zip</code>：</p>
<img src="https://examine-typora-picbed.oss-cn-beijing.aliyuncs.com/img/header.png" style="zoom: 67%;" />

<p>由于我们在 <code>temp.zip</code> 中放置了<strong>3</strong>个 <code>.txt</code> 文件，因此可以看到有<strong>3</strong>个表示<strong>数据区</strong>的文件头 <code>50 4B 03 04</code></p>
<h3 id="数据区"><a href="#数据区" class="headerlink" title="数据区"></a>数据区</h3><p><strong>数据区</strong>又可以划分为<strong>3</strong>部分：</p>
<ul>
<li><strong>File Header</strong> (文件头)</li>
<li><strong>File Data</strong> (文件数据)</li>
<li><strong>Data Descriptor</strong> (数据描述符)</li>
</ul>
<p><strong>File Header</strong>用于标识该文件的开始，它的结构如下：</p>
<table>
<thead>
<tr>
<th align="center">偏移量(Offset)</th>
<th align="center">长度(Length)</th>
<th align="center">内容(Contents)</th>
</tr>
</thead>
<tbody><tr>
<td align="center">0</td>
<td align="center"><strong>4</strong> bytes</td>
<td align="center">文件头(<code>50 4B 03 04</code>)</td>
</tr>
<tr>
<td align="center">4</td>
<td align="center">2 bytes</td>
<td align="center">解压需要的<strong>pkware</strong>最低版本</td>
</tr>
<tr>
<td align="center">6</td>
<td align="center">2 bytes</td>
<td align="center">通用位标记</td>
</tr>
<tr>
<td align="center">8</td>
<td align="center">2 bytes</td>
<td align="center"><strong>压缩方式</strong></td>
</tr>
<tr>
<td align="center">10</td>
<td align="center">2 bytes</td>
<td align="center">文件最后修改时间</td>
</tr>
<tr>
<td align="center">12</td>
<td align="center">2 bytes</td>
<td align="center">文件最后修改日期</td>
</tr>
<tr>
<td align="center">14</td>
<td align="center"><strong>4</strong> bytes</td>
<td align="center"><strong>CRC-32校验码</strong></td>
</tr>
<tr>
<td align="center">18</td>
<td align="center"><strong>4</strong> bytes</td>
<td align="center">压缩后大小</td>
</tr>
<tr>
<td align="center">22</td>
<td align="center"><strong>4</strong> bytes</td>
<td align="center">未压缩大小</td>
</tr>
<tr>
<td align="center">26</td>
<td align="center">2 bytes</td>
<td align="center">文件名长度（假设为<strong>n</strong>）</td>
</tr>
<tr>
<td align="center">28</td>
<td align="center">2 bytes</td>
<td align="center">扩展区长度（假设为<strong>m</strong>）</td>
</tr>
<tr>
<td align="center">30</td>
<td align="center"><strong>n</strong> bytes</td>
<td align="center">文件名</td>
</tr>
<tr>
<td align="center">30+n</td>
<td align="center"><strong>m</strong> bytes</td>
<td align="center">扩展区</td>
</tr>
</tbody></table>
<p><strong>File Data</strong>实际存储着被压缩文件的数据</p>
<p>而<strong>Data Descriptor</strong>，它只在<strong>文件被加密</strong>的情况下才会出现，就未加密的情况而言，它为空</p>
<hr>
<p>我们的 <code>temp.zip</code> 压缩着 <code>1.txt</code>、<code>2.txt</code>、<code>3.txt</code>，分别对应<strong>3</strong>个<strong>数据区</strong>，我们来详细看看第一个<strong>数据区</strong>：</p>
<img src="https://examine-typora-picbed.oss-cn-beijing.aliyuncs.com/img/first_data_chunk.png" style="zoom:80%;" />

<p>依次分析为：</p>
<ul>
<li><p><font color='red'>红色方框</font>的 <code>50 4b 03 04</code> 代表<strong>数据区</strong>的文件头标识</p>
</li>
<li><p><code>14 00</code> 表示pkware的最低版本、<code>00 00</code> 表示通用位标识、<code>08 00</code> 表示压缩方式、<code>72 bd</code> 和 <code>4d 50</code> 分别表示最后的修改时间和修改日期</p>
</li>
<li><p><code>03 c3 94 58</code> 是<strong>CRC-32校验码</strong></p>
</li>
<li><p>两个<font color='green'>绿色方块</font>分别表示压缩后、压缩前的文件体积大小 <code>0c 00 00 00</code> 和 <code>0a 00 00 00</code></p>
<p>值得一提的是，<code>.zip</code> 在存储文件大小的时候，使用的是<strong>小端序</strong></p>
<blockquote>
<p><strong>字节序</strong></p>
<p>计算机在存放<strong>字节</strong>数据的时候有<strong>2</strong>种顺序——<strong>大端序</strong>和<strong>小端序</strong></p>
<p><strong>大端序</strong>指高位字节在前、低位字节在后；<strong>小端序</strong>相反，低位字节在前、高位字节在后</p>
<p>举例来说，十六进制数值 <code>0x1234567</code> 的<strong>大端序</strong>为 <code>01 23 45 67</code>、<strong>小端序</strong>为 <code>67 45 23 01</code>（注意计算机以<strong>8</strong> bits(1 byte)为基本单位，不足8 bits补齐）</p>
<p>我们人类习惯读写<strong>大端序</strong>，而在计算机电路中，优先处理<strong>低位字节</strong>效率会比较高，因而采用<strong>小端序</strong>存储</p>
<p>计算机在处理字节时，并不知道什么是<strong>大端序</strong>什么是<strong>小端序</strong>，它只会按顺序读取字节，先读第一个字节，再读第二个</p>
<p>（事实上，<code>.zip</code> 存放大多数数据都采用<strong>小端序</strong>）</p>
</blockquote>
<p>所以，按<strong>小端序</strong>存储的 <code>0c 00 00 00</code> 实际上表示的数值是 <code>0xc</code>，对应十进制 <code>13</code>；同理，<code>0a 00 00 00</code> 对应的数值是 <code>0xa</code>，十进制为 <code>10</code></p>
<p>我们打开 <code>1.txt</code> 的详细信息，里面记载着 <code>1.txt</code> 的大小：<strong>10字节</strong>，恰好就是第二个<font color='green'>绿色方框</font>显示的数值（压缩前文件体积）</p>
<blockquote>
<p>为什么压缩后，文件大小反而由 <code>10</code> 增加到了 <code>13</code>？</p>
<p>这里涉及压缩的原理</p>
<p>假如文件中有大量重复的数据，如 <code>ABABABABABABCD</code>，如果我们把 <code>AB</code> 替换成 <code>X</code>，就成为了 <code>XXXXXXCD</code>，再在后面补充上 <code>X=AB</code>，这样会简洁很多</p>
<p>我们把&quot;在后面补充上 <code>X=AB</code> &quot;称之为<strong>增加控制信息</strong></p>
<p><strong>增加控制信息</strong>对应压缩来说是必须的步骤，但是如果压缩前文件信息本身就很<strong>紧凑</strong>，根本不用压缩，那么增加的<strong>冗余控制信息</strong>反倒会使体积变大</p>
</blockquote>
</li>
</ul>
<p>回到这张图：</p>
<img src="https://examine-typora-picbed.oss-cn-beijing.aliyuncs.com/img/first_data_chunk.png" style="zoom:80%;" />

<ul>
<li><p><code>05 00</code> 表示文件名长度、<code>00 00</code> 表示扩展区长度</p>
<p>很显然，<code>.zip</code> 对它们的存储也是通过<strong>小端序</strong></p>
</li>
<li><p><font color='blue'>蓝色方框</font>表示<strong>文件名</strong>，它占用的字节数由前面的 <code>05 00</code> 决定，<code>31 2e 74 78 74</code> 对应的ASCII码就是 <code>1.txt</code></p>
</li>
</ul>
<p>由于扩展区长度为 <code>00 00</code>，所以截止至<strong>文件名</strong>，就是<strong>数据区</strong>的<strong>File Header</strong>部分了</p>
<p><font color='grey'>黑色方框</font>对应的是<strong>File Data</strong>部分，随后就进入下一个<strong>数据区 <code>50 4B 03 04</code></strong> 了（因为该 <code>.zip</code> 未加密，所以<strong>Data Descriptor</strong>部分为空）</p>
<blockquote>
<p>可以通过Python的<strong>zlib</strong>模块实现模拟 <code>.zip</code> 的压缩和解压</p>
<p>还记得我们的 <code>1.txt</code> 的数据吗？——&quot;First Text&quot;</p>
<p><strong>zlib</strong>对这段字符串进行压缩的Python 3代码为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> zlib</span><br><span class="line">print(zlib.compress(<span class="string">b"First Text"</span>))</span><br><span class="line">	<span class="comment"># b'x\x9cs\xcb,*.Q\x08I\xad(\x01\x00\x14g\x03\xce'</span></span><br></pre></td></tr></table></figure>

<p>然后我们将 <code>.zip</code> 中的<font color='grey'>黑色方框</font>部分的数据显示出来：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">s = <span class="string">b"\x73\xcb\x2c\x2a\x2e\x51\x08\x49\xad\x28\x01\x00"</span></span><br><span class="line">print(s)</span><br><span class="line">	<span class="comment"># b's\xcb,*.Q\x08I\xad(\x01\x00'</span></span><br></pre></td></tr></table></figure>

<p>对比两次输出结果，我们发现，<font color='grey'>黑色方框</font>中提取出来的数据只是&quot;First Text&quot;经过压缩的<strong>一部分</strong>，分别缺少了前面的 <code>b&#39;x\x9c&#39;</code> 和后面的 <code>b&#39;\x14g\x03\xce&#39;</code></p>
<blockquote>
<p>个人理解是，</p>
<p><code>.zip</code> 中的 <code>73 cb 2c 2a 2e 51 08 49 ad 28 01 00</code> 才是 <code>1.txt</code> 真正的压缩数据，而首尾多出来的信息应该是属于<strong>压缩过程中添加的控制信息</strong></p>
<p>用 <code>2.txt</code> 来测试下，发现<strong>File Data</strong>的显示信息为 <code>b&#39;\x0bNM\xce\xcfKQ\x08I\xad(\x01\x00&#39;</code>，而&quot;Second Text&quot;经zlib压缩得到 <code>b&#39;x\x9c\x0bNM\xce\xcfKQ\x08I\xad(\x01\x00\x18^\x04&quot;&#39;</code></p>
<p>可以看到，同样增加了前面的 <code>b&#39;x\x9c&#39;</code> 和后面的 <code>b&#39;\x18^\x04&quot;&#39;</code></p>
<p>我们用 <code>zlib.decompress()</code> 去直接解压 <code>.zip</code> 中的<strong>File Data</strong>，会发现报错：<code>zlib.error: Error -3 while decompressing data: incorrect header check</code>（错误的文件头检测）</p>
<p>因此猜测，额外添加的<strong>控制信息</strong>中还有确保解压正确的信息</p>
</blockquote>
</blockquote>
<hr>
<p>理清楚了一个<strong>数据区</strong>中的部分数据含义后，我们再来看看之前被我们忽略的：</p>
<img src="https://examine-typora-picbed.oss-cn-beijing.aliyuncs.com/img/ms_dos_time.png" style="zoom:80%;" />

<p>仍然是 <code>1.txt</code> 在 <code>temp.zip</code> 的<strong>数据区</strong>部分，这次我们讲点其它的</p>
<p><font color='blue'>蓝色部分</font>分别是<strong>最后修改时间</strong>和<strong>最后修改日期</strong>，两者都采用的是<strong>MS-DOS格式</strong>（因为 <code>.zip</code> 程序是在MS-DOS上发明的）</p>
<ul>
<li><p><strong>MS-DOS时间</strong></p>
<p>将&quot;时&quot;、&quot;分&quot;、&quot;秒&quot;转换成<strong>16 bits</strong>格式（即2 bytes），转换过程为：</p>
<table>
<thead>
<tr>
<th align="center">位</th>
<th align="center">内容</th>
</tr>
</thead>
<tbody><tr>
<td align="center">0 - 4</td>
<td align="center">小时(24小时制，0 - 23)</td>
</tr>
<tr>
<td align="center">5 - 10</td>
<td align="center">分钟(0 - 59)</td>
</tr>
<tr>
<td align="center">11 - 15</td>
<td align="center">秒除以2</td>
</tr>
</tbody></table>
<blockquote>
<p>就拿上面的 <code>72 bd</code> 举例，由于采用<strong>小端序</strong>，因此实际存储的数值为 <code>0xbd72</code></p>
<p>我们查看 <code>1.txt</code> 的最后修改时间（我是通过<strong>exiftool</strong>），得到 <code>2020:02:13 23:43:35</code></p>
<p>如何由时间 <code>23:43:35</code> 得到 <code>bd72</code> 呢？</p>
<p>我们用Python将 <code>bd72</code> 转化成16位二进制字符串：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">n = <span class="string">"bd72"</span></span><br><span class="line">n = bin(int(n,<span class="number">16</span>))[<span class="number">2</span>:].zfill(<span class="number">16</span>)</span><br><span class="line">	<span class="comment"># n = '1011110101110010'</span></span><br></pre></td></tr></table></figure>

<p>按照上面表格的截取，得到</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">n1 = n[<span class="number">0</span>:<span class="number">5</span>] <span class="comment"># '10111'</span></span><br><span class="line">n2 = n[<span class="number">5</span>:<span class="number">11</span>] <span class="comment"># '101011'</span></span><br><span class="line">n3 = n[<span class="number">11</span>:] <span class="comment"># '10010'</span></span><br></pre></td></tr></table></figure>

<p>最后分别由二进制转成十进制：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">print(int(n1,<span class="number">2</span>)) <span class="comment"># 23</span></span><br><span class="line">print(int(n2,<span class="number">2</span>)) <span class="comment"># 43</span></span><br><span class="line">print(int(n3,<span class="number">2</span>)) <span class="comment"># 18</span></span><br></pre></td></tr></table></figure>

<p><code>n1</code>、<code>n2</code>、<code>n3</code> 分别得到 <code>23 43 18</code>，对比时间 <code>23:43:35</code>，将<strong>秒</strong>乘以$2$后，整个时间只有$1$秒的误差！</p>
</blockquote>
</li>
<li><p><strong>MS-DOS日期</strong></p>
<p><b><font color='red'>此表存疑</font></b></p>
<table>
<thead>
<tr>
<th align="center">位</th>
<th align="center">内容</th>
</tr>
</thead>
<tbody><tr>
<td align="center">0 - 4</td>
<td align="center">年份</td>
</tr>
<tr>
<td align="center">5 - 8</td>
<td align="center">月份</td>
</tr>
<tr>
<td align="center">9 - 15</td>
<td align="center">日</td>
</tr>
</tbody></table>
<blockquote>
<p>我没能在网上找到<strong>MS-DOS日期和时间</strong>转16 bits值的公式</p>
<p>但是依照上表进行解析，似乎发现了一点规律：</p>
<ul>
<li>我在 <code>2020/02/13</code> 新建了一个 <code>.txt</code>，压缩为 <code>.zip</code> 后查看日期为 <code>4d 50</code>，根据上表进行解析，得到 <code>10 0 77</code></li>
<li>我在后一天 <code>2020/02/14</code> 进行了同样的操作，得到结果 <code>10 0 78</code></li>
</ul>
<p>感觉<strong>MS-DOS日期</strong>是以某年某天为参考系的...</p>
</blockquote>
</li>
</ul>
<p>回到这张图：</p>
<img src="https://examine-typora-picbed.oss-cn-beijing.aliyuncs.com/img/ms_dos_time.png" style="zoom:80%;" />

<p><font color='red'>红色方框</font>存储着<strong>CRC-32校验码</strong></p>
<p>在学习 <code>.png</code> 格式的过程中，就已经了解过<strong>CRC-32</strong>是一种生成8 bytes(32 bits)固定长度字符串的哈希算法</p>
<p><code>.zip</code> 的<strong>CRC-32校验</strong>只对<strong>源文件的内容</strong>进行运算，例如，<code>1.txt</code> 的文件内容为&quot;First Text&quot;，用Python 2快速计算下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> zlib</span><br><span class="line">temp = hex(zlib.crc32(<span class="string">"First Text"</span>) &amp; <span class="number">0xffffffff</span>)</span><br><span class="line"><span class="keyword">print</span> temp</span><br><span class="line">	<span class="comment"># 0x5894c303L</span></span><br></pre></td></tr></table></figure>

<p>因为是<strong>小端序</strong>，所以可看到输出结果与图中的 <code>03 c3 94 58</code> 一致</p>
<hr>
<h4 id="CRC碰撞"><a href="#CRC碰撞" class="headerlink" title="CRC碰撞"></a>CRC碰撞</h4><blockquote>
<p>在CTF，可能给你一个加密了的 <code>.zip</code> 文件，并且密码很长，不太可能通过暴力破解得到密码；但是里面只包含一个小小的 <code>.txt</code> 文件，记录着<strong>长度不到30</strong>的flag</p>
</blockquote>
<p>我们留意到<strong>CRC-32校验码</strong>只对源数据进行运算，如果我们无法爆破 <code>.zip</code> 的密码，那么不妨直接爆破里面的flag</p>
<p>HBCTF中的一道题：</p>
<blockquote>
<p>链接：<a href="https://pan.baidu.com/s/10fWciZ0OLhYxa_ZVBmp6tg" target="_blank" rel="noopener">https://pan.baidu.com/s/10fWciZ0OLhYxa_ZVBmp6tg</a><br>提取码：rfnb</p>
</blockquote>
<p>&emsp;</p>
<p><strong>解答</strong></p>
<p>打开 <code>.zip</code>，看到</p>
<img src="https://examine-typora-picbed.oss-cn-beijing.aliyuncs.com/img/flag_six.png" style="zoom:67%;" />

<p>提示我们flag为6位数，并且根据原始大小 <code>6</code> 猜测文件 <code>flag6位数</code> 中只包含为flag的那6位数；又知道了这6位数的<strong>CRC-32校验码</strong>，写脚本对这6位数进行爆破：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Python 2</span></span><br><span class="line"><span class="keyword">import</span> zlib</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">100000</span>, <span class="number">1000000</span>):</span><br><span class="line">	<span class="keyword">if</span> hex(zlib.crc32(str(i)) &amp; <span class="number">0xffffffff</span>)[<span class="number">2</span>:<span class="number">-1</span>] == <span class="string">"9c4d9a5d"</span>:</span><br><span class="line">		<span class="keyword">print</span> i</span><br></pre></td></tr></table></figure>

<p>最后得到的输出结果 <code>954288</code> 就是flag了</p>
<blockquote>
<p>限于CPU能力，<strong>CRC碰撞</strong>只能用于压缩文件较小的情况</p>
</blockquote>
<hr>
<h4 id="CRC碰撞脚本"><a href="#CRC碰撞脚本" class="headerlink" title="CRC碰撞脚本"></a>CRC碰撞脚本</h4><p><strong>CRC碰撞</strong>有时是极耗费时间的，所以不妨借助一些经过优化的工具来加速碰撞</p>
<ul>
<li><p>文件字节数$\leq$5时（可以自己写脚本爆破）</p>
<p>我在网络上找到一个适用于字节数$\leq$5的Python 3的<strong>CRC碰撞</strong>脚本 <code>crcak.py</code></p>
<blockquote>
<p>链接：<a href="https://pan.baidu.com/s/1ucUlL8twOFFS1g6e0P1kjw" target="_blank" rel="noopener">https://pan.baidu.com/s/1ucUlL8twOFFS1g6e0P1kjw</a><br>提取码：jjl6 </p>
</blockquote>
<p>使用方法：<code>python crcak.py temp.zip</code>，脚本会自动判别字节数</p>
<p>（实测字节数等于6也可以，但是非常慢）</p>
</li>
<li><p>文件字节数等于6时，借助<a href="https://github.com/theonlypwner/crc32" target="_blank" rel="noopener">Github</a>上的脚本 <code>crc32.py</code></p>
<p>将脚本clone到本地，可以使用 <code>-h</code> 参数查看用法：</p>
<img src="https://examine-typora-picbed.oss-cn-beijing.aliyuncs.com/img/script_crc32.png" style="zoom:67%;" />

<p>单就<strong>CRC碰撞</strong>来讲，它的用法为：<code>python crc32.py reverse 0x8位校验码</code></p>
<p>长度为6 bytes文本的<strong>CRC校验码</strong>已经有可能出现重复了：</p>
<img src="https://examine-typora-picbed.oss-cn-beijing.aliyuncs.com/img/crc32_same.png" style="zoom:67%;" />

<p>该脚本会快速罗列出所有有可能的字符串</p>
<blockquote>
<p>值得一提的是，打开 <code>crc32.py</code> 可以看到它的字符集：</p>
<img src="https://examine-typora-picbed.oss-cn-beijing.aliyuncs.com/img/11212.png" alt="image-20201011110050411" style="zoom:67%;" />

<p>很显然它缺少一些特殊字符，有可能导致无法碰撞出正确结果；自行添加上去即可</p>
</blockquote>
</li>
<li><p>文本长度$\geq$7的就不推荐使用<strong>CRC碰撞</strong>了</p>
</li>
</ul>
<hr>
<p>到这里，<strong>数据区</strong>的分析就告一段落</p>
<p>注意，<strong>数据区</strong>的名字虽然是&quot;数据&quot;，但它的定义是<strong>记录</strong>，<font color='red'><b>数据区</b>中每一个压缩的源文件/目录都是一条<b>记录</b></font></p>
<p>真正存储数据的地方是后面的<strong>目录区</strong></p>
<hr>
<h3 id="目录区"><a href="#目录区" class="headerlink" title="目录区"></a>目录区</h3><p><strong>目录区</strong>在官方文档中的定义是<strong>核心目录(Central Directory)</strong>，<strong>数据区</strong>中的每一条记录都对应<strong>目录区</strong>中的一条数据</p>
<p>就结构而言，<strong>目录区</strong>和<strong>数据区</strong>还是很相似的</p>
<p>我们用<strong>数据区</strong>来对比，查看 <code>1.txt</code> 在 <code>temp.zip</code> 中的<strong>目录区</strong>数据：</p>
<img src="https://examine-typora-picbed.oss-cn-beijing.aliyuncs.com/img/empty_data.png" style="zoom:80%;" />

<center>↑ 数据区截图</center>
<img src="https://examine-typora-picbed.oss-cn-beijing.aliyuncs.com/img/dir.png" style="zoom:80%;" />

<p><strong>数据区</strong>的文件头标识为 <code>50 4B 03 04</code>，而<strong>目录区</strong>则是 <code>50 4B 01 02</code>，对应上图的<font color='grey'>黑色方框</font></p>
<p>在<strong>数据区</strong>，原本文件头标识后面就是2 bytes的pkware版本，而在<strong>目录区</strong>，它被扩展为4 bytes，前2 bytes仍然是新出现的<strong>压缩所用的pkware版本</strong>，后2 bytes则是原先的<strong>解压所需的pkware最低版本</strong></p>
<p>后面的基本与<strong>数据区</strong>相同，<code>00 00</code> 表示通用位标记，<code>08 00</code> 表示压缩方法，<code>72 bd 4d 50</code> 分别表示最后修改时间和日期，<code>03 c3 94 58</code> 表示源数据的CRC-32校验码，<code>0c 00 00 00</code> 和 <code>0a 00 00 00</code> 分别表示压缩后文件大小、压缩前文件大小，<code>05 00</code> 表示文件名长度，<code>24 00</code> 表示扩展区长度</p>
<blockquote>
<p>在<strong>目录区</strong>，扩展区开始不为空</p>
</blockquote>
<p>图中，随后的<strong>5</strong>个<font color='blue'>蓝色方框</font>都是相比较<strong>数据区</strong>，新出现的东西</p>
<blockquote>
<p>然而这些都不在我们的主要讨论范围内，看一下就够了</p>
</blockquote>
<p>首先的 <code>00 00</code> 表示&quot;文件注释长度&quot;，之后的 <code>00 00</code> 表示&quot;文件开始位置的磁盘编号&quot;，再之后的 <code>00 00</code> 表示&quot;内部文件属性&quot;</p>
<p><code>20 00 00 00</code> 表示&quot;外部文件属性&quot;，<code>00 00 00 00</code> 表示&quot;本地文件头的相对位移&quot;</p>
<p>跳过这些后，到了表示<strong>文件名</strong>的 <code>31 2e 74 78 74</code></p>
<p><strong>目录区</strong>不像<strong>数据区</strong>由①File Header；②File Data；③Data Descriptor组成，所以文件名结束后，就到了<strong>拓展区</strong>和<strong>文件注释内容</strong>，它们分别由之前的长度确定</p>
<hr>
<p>请看这个：</p>
<img src="https://examine-typora-picbed.oss-cn-beijing.aliyuncs.com/img/flag.png" style="zoom:80%;" />

<p>它是我们一直没怎么在意的<strong>通用位标记</strong>，它同时存在于<strong>数据区</strong>和<strong>目录区</strong>，但只在<strong>目录区</strong>发挥效果</p>
<blockquote>
<p>因为<strong>数据区</strong>只是<strong>记录</strong></p>
</blockquote>
<p>我们把<font color='green'>绿色方框</font>中的2 bytes数据称为<strong>通用位标记(General Purpose Bit Flag)</strong>，实际上它与 <code>.zip</code> 的<strong>加密</strong>有关，这2 bytes对应的16 bits也被称之为<strong>加密位</strong></p>
<p>我们重复创建 <code>temp.zip</code> 的操作——将 <code>1.txt</code>、<code>2.txt</code>、<code>3.txt</code> 压缩成 <code>.zip</code> 文件，但是这次设置了密码 <code>abcd</code>，得到 <code>secret.zip</code></p>
<p>在Bandizip中分别打开 <code>temp.zip</code> 和 <code>secret.zip</code>，可以看到：标注了 <code>*</code> 号为加密文件：</p>
<img src="https://examine-typora-picbed.oss-cn-beijing.aliyuncs.com/img/jiami_or_not.png" style="zoom: 67%;" />

<p>使用十六进制编辑器打开 <code>secret.zip</code>，查看<strong>数据区</strong>：</p>
<img src="https://examine-typora-picbed.oss-cn-beijing.aliyuncs.com/img/jiami.png" style="zoom:80%;" />

<p>与原先未加密进行对比，变动的主要是上图各色方框的位置</p>
<blockquote>
<p><strong>关于 <code>.zip</code> 的加密算法</strong></p>
<p><code>.zip</code> 是允许多种无损压缩算法的，但最常用的算法为<strong>Deflate</strong>，以及Deflate的微型改进版——<strong>Deflate64</strong></p>
<p><strong>zip压缩软件</strong>在得到用户设置的密码后，会根据密码动态修改自身的压缩算法（其实是改变了压缩算法中的个别参数）</p>
<p>正因为如此，通过密码而动态改变的压缩算法本质上起到了<strong>加密算法</strong>的作用</p>
<p>【参考】：<a href="https://bbs.csdn.net/topics/10315681" target="_blank" rel="noopener">https://bbs.csdn.net/topics/10315681</a></p>
</blockquote>
<p>我们首先看加密后的<font color='red'>红色方框</font>和<font color='grey'>黑色方框</font>部分，可以看到，经过ZIP加密后，加密后的 <code>1.txt</code> 文件体积增加到了 <code>0x18</code> bytes，而下方的<strong>File Data</strong>区域也经过了加密，变得不可读</p>
<p><strong>数据区</strong>是<strong>目录区</strong>的记录，因此<strong>目录区</strong>也发生了相同的变化：</p>
<img src="https://examine-typora-picbed.oss-cn-beijing.aliyuncs.com/img/secret_dir.png" style="zoom:80%;" />

<p><code>1.txt</code> 的真实压缩数据位于<strong>数据区</strong>的<strong>File Data</strong>，而<strong>目录区</strong>没有，因此加密后<strong>目录区</strong>的变化少于<strong>数据区</strong></p>
<blockquote>
<p>......</p>
</blockquote>
<p>&emsp;</p>
<p>重点在于<font color='green'>绿色方框</font>中的数据</p>
<p>我们参考pkware的<a href="https://pkware.cachefly.net/webdocs/APPNOTE/APPNOTE-6.2.0.txt" target="_blank" rel="noopener">官方文档</a>，在<strong>general purpose bit flag</strong>一栏中能够看到详细的解释：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">general purpose bit flag: (2 bytes)</span><br><span class="line"></span><br><span class="line">          Bit 0: If set, indicates that the file is encrypted.</span><br><span class="line"></span><br><span class="line">          (For Method 6 - Imploding)</span><br><span class="line">          Bit 1: If the compression method used was type 6,</span><br><span class="line">                 Imploding, then this bit, if set, indicates</span><br><span class="line">                 an 8K sliding dictionary was used.  If clear,</span><br><span class="line">                 then a 4K sliding dictionary was used.</span><br><span class="line">          Bit 2: If the compression method used was type 6,</span><br><span class="line">                 Imploding, then this bit, if set, indicates</span><br><span class="line">                 3 Shannon-Fano trees were used to encode the</span><br><span class="line">                 sliding dictionary output.  If clear, then 2</span><br><span class="line">                 Shannon-Fano trees were used.</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>将<strong>加密位</strong>的<strong>2</strong> bytes展开成16 bits，这16个二进制位，每一位都相当于一个开关；当某一位上的开关被打开(设置为 <code>1</code>，set)，那么就会启动相应的功能</p>
<p>我们看文档中的 <code>Bit 0</code>，它强调：<strong>如果开启，则表明该文件已加密</strong></p>
<p>也就是说，16 bits中的最低位如果为 <code>1</code>，那么 <code>.zip</code> 会认为这是一个已经经过加密的文件；倘若人为地修改<strong>未加密文件</strong>的加密位的最低位为 <code>1</code>，那么哪怕没有设置密码，<code>.zip</code> 也会判定它是一个已加密文件</p>
<p>这也就引申出CTF中的一类题目——<strong>zip伪加密</strong></p>
<hr>
<h4 id="zip伪加密"><a href="#zip伪加密" class="headerlink" title="zip伪加密"></a>zip伪加密</h4><p>人为地修改<strong>目录区</strong>中，<strong>加密位</strong>的最低位为 <code>1</code>，ZIP压缩软件将判定 <code>.zip</code> 经过加密；解压时，会在没有设置密码的情况下，要求输入密码，否则解压失败</p>
<blockquote>
<p><strong>位运算</strong></p>
<p>在学习位运算的时候，就有过一道经典的题目：快速判断一个数是否是奇数</p>
<p>常规做法是，<code>if (n % 2 == 1)</code> 通过<strong>取模</strong>运算</p>
<p>而在位运算中，更快的做法是 <code>if (n &amp; 1 == 1)</code> </p>
<p>理由是，所有的数如果都转换成二进制表示，那么每个数都可以表示成：$a_{n} × 2^n + a_{n-1} × 2^{n-1} + a_{n-2} × 2^{n-2} + ... + a_1 × 2^1 + a_0 × 2^0$</p>
<p>（$a_0$到$a_n$是各二进制比特位上的取值）</p>
<p>因此，一个数的奇偶性就取决于最后一位$a_0$的取值</p>
</blockquote>
<p>ZIP压缩软件会将<strong>加密位</strong>最低位为 <code>1</code> 视为加密，也就是说，加密位上的数值被修改为<strong>奇数</strong>，那么都将实现<strong>伪加密</strong></p>
<hr>
<p>实验一下，十六进制编辑器打开 <code>temp.zip</code>，定位到 <code>1.txt</code> 的<strong>目录区</strong>的加密位上，手动把它更改为 <code>07 00</code>：</p>
<img src="https://examine-typora-picbed.oss-cn-beijing.aliyuncs.com/img/change.png" style="zoom:80%;" />

<p>Bandizip打开 <code>temp.zip</code>，发现：</p>
<img src="https://examine-typora-picbed.oss-cn-beijing.aliyuncs.com/img/just_one_encrypt.png" style="zoom: 67%;" />

<p>可以看到，在没有设置密码的情况下，解压 <code>1.txt</code> 需要输入密码</p>
<blockquote>
<p>这种情况一看就是<strong>zip伪加密</strong>，正常的压缩包加密都是把里面所有的文件都加密的，不可能出现单个文件加密、其余未加密的情况</p>
<p>所以通常将每个文件的<strong>加密位</strong>都做手脚，让<strong>zip伪加密</strong>更难被发现</p>
</blockquote>
<hr>
<p>由于<strong>zip伪加密</strong>仅仅只是修改了<strong>加密位</strong>的最后一位，使得ZIP压缩软件错误进行了&quot;索要密码&quot;的行为，除此之外，对 <code>.zip</code> 没有任何修改</p>
<p>这也意味着<strong>zip伪加密</strong>是脆弱的</p>
<ul>
<li><code>binwalk -e</code> 能够无视<strong>伪加密</strong>，直接解压出里面的文件</li>
<li>在Mac OS以及部分Linux(如Kali)中，可以直接打开<strong>伪加密</strong>的 <code>.zip</code> 压缩包</li>
</ul>
<p>当压缩文件较多，或者我们不想逐个字节的去找到<strong>加密位</strong>的时候，可以借助一些工具——检测<strong>zip伪加密</strong>的Java小工具 <code>ZipCenOp.jar</code></p>
<blockquote>
<p>链接：<a href="https://pan.baidu.com/s/1SokyYdAW8C8Pfs1kRTm5Dw" target="_blank" rel="noopener">https://pan.baidu.com/s/1SokyYdAW8C8Pfs1kRTm5Dw</a><br>提取码：e48i </p>
</blockquote>
<p>使用方法为：打开CMD窗口，键入</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">java -jar ZipCenOp.jar r temp.zip <span class="comment"># 解密</span></span><br><span class="line">java -jar ZipCenOp.jar e temp.zip <span class="comment"># 加密</span></span><br></pre></td></tr></table></figure>

<p>解密时，会显示 <code>success x flag(s) found</code>，这时再次打开 <code>.zip</code>，会发现表示加密的 <code>*</code> 已经消失了，能够直接打开</p>
<blockquote>
<p><strong>注意</strong></p>
<p>亲测， <code>ZipCenOp.zip</code> 对正常加密的 <code>.zip</code> 压缩包会直接修改所有<strong>加密位</strong>为偶数，虽然会让ZIP压缩软件显示&quot;未加密&quot;，但往往 <code>.zip</code> 文件也损坏了，得到&quot;CRC校验错误&quot;的结果</p>
<p>所以如果拿到加密了的 <code>.zip</code> 文件，还是建议用十六进制编辑器打开，将<strong>加密位</strong>手动改回偶数；如果发现损坏了，则证明不是<strong>伪加密</strong>，再把<strong>加密位</strong>改回，尝试其它办法</p>
<blockquote>
<p>可以比对<strong>数据区</strong>和<strong>目录区</strong>的<strong>加密位</strong>，<strong>伪加密</strong>往往只会修改<strong>目录区</strong>的<strong>加密位</strong>（因为这样就能起到效果），而正常的加密会同时修改两者的<strong>加密位</strong></p>
<p>如果出题人把两处的<strong>加密位</strong>都修改了，那只好一一尝试了</p>
</blockquote>
</blockquote>
<p>此外，我在之前认为，一个压缩包中的文件要么不加密、要么全加密，不可能出现<strong>部分文件加密、部分文件不加密</strong>的情况，这种情况的出现只能是<strong>伪加密</strong>导致的；然而经过测试，真的可以做到这样</p>
<p>以Bandizip压缩软件为例：</p>
<ul>
<li>先将 <code>temp1.txt</code> 压缩为 <code>try1.zip</code>，然后用Bandizip打开 <code>try1.zip</code>，把 <code>temp2.txt</code> 拖入，加入压缩包中；这时可以选择为 <code>temp2.txt</code> 添加密码</li>
<li>或者先将 <code>temp1.txt</code> 加密压缩为 <code>try2.zip</code>，然后拖入 <code>temp2.txt</code> 时选择不加密</li>
</ul>
<p>经过测试，<code>.zip</code> 和 <code>.rar</code> 都允许这样的操作</p>
<p>更有甚者，把 <code>temp1.txt</code> 加密压缩时选择一个密码，把 <code>temp2.txt</code> 拖入时选择另外一个密码，这样在解压时，需要输入两个密码Orz</p>
<p>所以这个不能再作为是否是<strong>伪加密</strong>的依据了</p>
<hr>
<h3 id="目录结束标志"><a href="#目录结束标志" class="headerlink" title="目录结束标志"></a>目录结束标志</h3><p>我们已经大致浏览过了文件头为 <code>50 4B 03 04</code> 的<strong>数据区</strong>、文件头为 <code>50 4B 01 02</code> 的<strong>目录区</strong>，那么对于一个 <code>.zip</code> 文件，最后的部分就是文件头为 <code>50 4B 05 06</code> 的<strong>目录结束标志</strong>了</p>
<p>这部分在CTF中没什么应用，适当忽略，在这里仅作记录</p>
<p>我们查看 <code>temp.zip</code> 的<strong>目录结束标志</strong>部分：</p>
<img src="https://examine-typora-picbed.oss-cn-beijing.aliyuncs.com/img/end_dir.png" style="zoom:80%;" />

<p><code>50 4b 05 06</code> 是<strong>文件头</strong>，<code>00 00</code> 表示当前磁盘编号， <code>00 00</code> 表示目录区开始磁盘编号，<code>03 00</code> 表示本磁盘上记录总数，<code>03 00</code> 表示目录区记录总数，<code>05 01 00 00</code> 表示目录区尺寸大小，<code>8e 00 00 00</code> 表示目录区对第一张磁盘的偏移量，<code>00 00</code> 表示ZIP文件的注释长度</p>
<hr>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/CTF/" rel="tag"># CTF</a>
              <a href="/tags/Misc/" rel="tag"># Misc</a>
              <a href="/tags/Archive/" rel="tag"># Archive</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-next post-nav-item">
                <a href="/2020/12/20/%E4%BA%8C%E7%BB%B4%E7%A0%81%E9%A2%98%E7%9B%AE/" rel="next" title="二维码题目">
                  <i class="fa fa-chevron-left"></i> 二维码题目
                </a>
            </div>

            <span class="post-nav-divider"></span>

            <div class="post-nav-prev post-nav-item">
                <a href="/2021/01/12/CTF%E4%B8%AD%E7%9A%84zip%EF%BC%88%E4%B8%8B%EF%BC%89/" rel="prev" title="CTF中的zip（下）">
                  CTF中的zip（下） <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          
    <div class="comments" id="comments"></div>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#zip文件格式"><span class="nav-number">1.</span> <span class="nav-text">zip文件格式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#数据区"><span class="nav-number">1.1.</span> <span class="nav-text">数据区</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#CRC碰撞"><span class="nav-number">1.1.1.</span> <span class="nav-text">CRC碰撞</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#CRC碰撞脚本"><span class="nav-number">1.1.2.</span> <span class="nav-text">CRC碰撞脚本</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#目录区"><span class="nav-number">1.2.</span> <span class="nav-text">目录区</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#zip伪加密"><span class="nav-number">1.2.1.</span> <span class="nav-text">zip伪加密</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#目录结束标志"><span class="nav-number">1.3.</span> <span class="nav-text">目录结束标志</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="site-author-image" itemprop="image" alt="examine"
    src="/images/none.ico">
  <p class="site-author-name" itemprop="name">examine</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">13</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/examine2" title="GitHub &amp;rarr; https:&#x2F;&#x2F;github.com&#x2F;examine2" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
  </div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">examine</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    <span title="Symbols count total">148k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">4:06</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> v4.0.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">Theme – <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> v7.4.2
  </div>

        












        
      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js?v=3.1.0"></script>
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
<script src="/js/utils.js?v=7.4.2"></script><script src="/js/motion.js?v=7.4.2"></script>
<script src="/js/schemes/pisces.js?v=7.4.2"></script>
<script src="/js/next-boot.js?v=7.4.2"></script>



  


















  

  
      
<script type="text/x-mathjax-config">

  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$', '$'], ['\\(', '\\)'] ],
      processEscapes: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    TeX: {
      equationNumbers: {
        autoNumber: 'AMS'
      }
    }
  });

  MathJax.Hub.Register.StartupHook('TeX Jax Ready', function() {
    MathJax.InputJax.TeX.prefilterHooks.Add(function(data) {
      if (data.display) {
        var next = data.script.nextSibling;
        while (next && next.nodeName.toLowerCase() === '#text') {
          next = next.nextSibling;
        }
        if (next && next.nodeName.toLowerCase() === 'br') {
          next.parentNode.removeChild(next);
        }
      }
    });
  });

  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for (i = 0; i < all.length; i += 1) {
      element = document.getElementById(all[i].inputID + '-Frame').parentNode;
      if (element.nodeName.toLowerCase() == 'li') {
        element = element.parentNode;
      }
      element.classList.add('has-jax');
    }
  });
</script>
<script>
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mathjax@2/MathJax.js?config=TeX-AMS-MML_HTMLorMML', () => {
    MathJax.Hub.Typeset();
  }, window.MathJax);
</script>

    

  

  


<script>
NexT.utils.getScript('https://cdn.jsdelivr.net/npm/valine@1.3.10/dist/Valine.min.js', () => {
  var GUEST = ['nick', 'mail', 'link'];
  var guest = 'nick,mail,link';
  guest = guest.split(',').filter(item => {
    return GUEST.includes(item);
  });
  new Valine({
    el: '#comments',
    verify: true,
    notify: false,
    appId: 'AcnzIAQVbbnuGkhPPb8cjbgW-gzGzoHsz',
    appKey: 'TLbccV8U8hEzCr7sXQrbouRU',
    placeholder: "Welcome to comment.",
    avatar: 'mm',
    meta: guest,
    pageSize: '10' || 10,
    visitor: false,
    lang: 'zh-cn' || 'zh-cn',
    path: location.pathname,
    recordIP: false,
    serverURLs: ''
  });
}, window.Valine);
</script><!-- hexo-inject:begin --><!-- hexo-inject:end -->

</body>
</html>
